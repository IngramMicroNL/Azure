#AOBO - Minimum privileges

$All_Subs = Get-AzSubscription
$CurrentUser = Get-AzADUser -signedIn
$CurrentUserId = $CurrentUser.Id

$Roles = "Support Request Contributor", "Reader", "Quota Request Operator"

foreach ($Sub in $All_Subs) {
    Set-AzContext -Subscription $Sub
    $Sub_Id = $Sub.Id
    $RBACCheck = Get-AzRoleAssignment -ObjectId $CurrentUserId -RoleDefinitionName "Owner" -Scope "/subscriptions/$Sub_Id"
    if ($RBACCheck -eq $null) {
        New-AzRoleAssignment -ObjectId $CurrentUserId -RoleDefinitionName "Owner" -Scope "/subscriptions/$Sub_Id" -ErrorAction SilentlyContinue
    }
    $Sub_Id = $null
}

Start-Sleep 5
$ErrorCheck = $null
New-AzManagementGroup -GroupId "Placeholder_To_Be_Removed" -ErrorVariable ErrorCheck
Start-Sleep 2

if ($ErrorCheck -ne $null) { 
  Write-Output "`n `n `n `n `n `n `n" 
  Write-Output "Error detected - please verify if the current user is Global Administrator and chapter 1 has been completed. Please run the script again. If errors persist: sign out and sign back into the Azure portal."
  Pause
  Exit
}

$MGList = Get-AzManagementGroup -ErrorAction SilentlyContinue        
$ErrorCheck = $null

foreach ($MG in $MGList) {
    foreach ($Role in $Roles) {
        $RBACCheck = Get-AzRoleAssignment -ObjectId $CurrentUserId -RoleDefinitionName $Role -Scope $MG.Id
        if ($RBACCheck -eq $null) {
            $HideOutput = New-AZRoleAssignment -ObjectId "34c4dd11-78c0-41e5-8370-c6dbf16bc3e9" -ObjectType "ForeignGroup" -RoleDefinitionName $Role -Scope $MG.Id -ErrorVariable ErrorCheck -ErrorAction SilentlyContinue
        }
    }
}

foreach ($Sub in $All_Subs) {
    Set-AzContext -Subscription $Sub
    $Sub_Id = $Sub.Id
    
    foreach ($Role in $Roles) {
        $RBACCheck = Get-AzRoleAssignment -ObjectId $CurrentUserId -RoleDefinitionName $Role -Scope "/subscriptions/$Sub_Id"
        if ($RBACCheck -eq $null) {
            $HideOutput = New-AzRoleAssignment -ObjectId "34c4dd11-78c0-41e5-8370-c6dbf16bc3e9" -ObjectType "ForeignGroup" -RoleDefinitionName $Role -Scope "/subscriptions/$Sub_Id" -ErrorAction SilentlyContinue -ErrorVariable ErrorCheck
        }
    }
    $Sub_Id = $null
}

Remove-AzManagementGroup -GroupId "Placeholder_To_Be_Removed" 
Start-Sleep 2

$ErrorCheck = $null 
if ($ErrorCheck -match "Conflict" -or $ErrorCheck -eq $null) { 
  Write-Output "`n `n `n `n `n `n `n" 
  Write-Output "Deployment was succesful, please contact your known contact at Ingram Micro or your 
  IT Partner to inform them. Cloud Shell may be closed now." 
  Pause 
  Exit 
} 
if ($ErrorCheck -notmatch "Conflict" -and $ErrorCheck -ne $null) { 
  Write-Output "`n `n `n `n `n `n `n" 
  Write-Output $ErrorCheck 
  Write-Output "Errors were found, please contact your known contact at Ingram Micro or your IT 
  Partner for further analysis."
}
#
#End
